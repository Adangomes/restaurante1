<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASA DA CERVEJA - Admin</title>
    <link rel="stylesheet" href="admin.css">
</head>
<body>
<div id="login-admin" style="position:fixed; inset:0; background:#000; z-index:30000; display:flex; align-items:center; justify-content:center;">
    <div style="background:#111; padding:40px; border-radius:20px; text-align:center; width:320px;">
        <h2 style="color:#ffcc00;">CASA DA CERVEJA</h2>
        <input type="password" id="senhaAdmin" placeholder="Digite a senha" style="width:100%; padding:15px; font-size:18px; border-radius:10px; border:none; margin:20px 0;">
        <button onclick="verificarSenha()" style="width:100%; padding:15px; font-size:18px; background:#ffcc00; border:none; border-radius:10px; font-weight:bold; cursor:pointer;">ENTRAR</button>
        <p id="erro-senha" style="color:red; display:none;">Senha incorreta</p>
    </div>
</div>

<div id="container-ativacao" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:10000; display:flex; align-items:center; justify-content:center;">
    <button onclick="ativarSomEDestravar()" style="padding:30px 60px; font-size:24px; background:#ffcc00; color:#000; border:none; border-radius:15px; font-weight:bold; cursor:pointer;">
        ATIVAR SOM DO SISTEMA
    </button>
</div>

<header class="admin-header">
    <h1>CASA DA <span>CERVEJA</span></h1>
    <button class="btn-relatorio" onclick="abrirRelatorio()">HISTÃ“RICO</button>
</header>

<ul id="pedidos-container"></ul>

<div id="modal-relatorio" class="modal">
    <div class="modal-content">
        <span style="float:right; cursor:pointer; font-size:28px; color:white;" onclick="fecharRelatorio()">&times;</span>
        <h2 style="text-align:center; color:#ffcc00;">HISTÃ“RICO DE VENDAS</h2>
        <div class="stats-container">
            <div class="stat-box">PEDIDOS<br><b id="rel-qtd">0</b></div>
            <div class="stat-box">TOTAL VENDIDO<br><b id="rel-total">R$ 0,00</b></div>
        </div>
        <div class="table-wrapper">
            <table class="table-rel">
                <thead><tr><th>Hora</th><th>Cliente</th><th>Valor</th></tr></thead>
                <tbody id="tabela-relatorio"></tbody>
            </table>
        </div>
        <button class="btn-limpar" onclick="limparRelatorio()">LIMPAR HISTÃ“RICO</button>
    </div>
</div>

<iframe id="iframe-impressao" style="display:none;"></iframe>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    // ===============================
    // ðŸ” CONFIG SENHA ADMIN
    // ===============================
    const SENHA_ADMIN = "cerveja2026"; // Mudei para combinar com o cliente

    function verificarSenha() {
        const senha = document.getElementById("senhaAdmin").value;
        if (senha === SENHA_ADMIN) {
            document.getElementById("login-admin").style.display = "none";
            localStorage.setItem("admin_logado_cerveja", "true");
        } else {
            document.getElementById("erro-senha").style.display = "block";
        }
    }

    if (localStorage.getItem("admin_logado_cerveja") === "true") {
        document.getElementById("login-admin").style.display = "none";
    }

    // ===============================
    // ðŸ”¹ FIREBASE CONFIG
    // ===============================
    const firebaseConfig = {
        apiKey: "AIzaSyCXA1yP1F-riNkzOX5zJs5gsQ82EzsT7Qg",
        authDomain: "myproject26-10f0e.firebaseapp.com",
        databaseURL: "https://myproject26-10f0e-default-rtdb.firebaseio.com",
        projectId: "myproject26-10f0e",
        storageBucket: "myproject26-10f0e.firebasestorage.app",
        messagingSenderId: "884850608032",
        appId: "1:884850608032:web:79db6983346c3c20edc6c5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // CAMINHOS ATUALIZADOS
    const PATH_PEDIDOS = 'pedidos/casa_da_cerveja';
    const PATH_RELATORIOS = 'relatorios/casa_da_cerveja';

    let prontoParaTocar = false;
    let contadorPedidos = 0;

    function ativarSomEDestravar() {
        const context = new(window.AudioContext || window.webkitAudioContext)();
        if (context.state === 'suspended') context.resume();
        const audio = new Audio('alert.mpeg');
        audio.play().then(() => {
            prontoParaTocar = true;
            document.getElementById('container-ativacao').style.display = 'none';
        }).catch(() => {
            // Se falhar, tenta apenas fechar o modal
            prontoParaTocar = true;
            document.getElementById('container-ativacao').style.display = 'none';
        });
    }

    // ===============================
    // ðŸ”” OUVIR PEDIDOS (NOVO CAMINHO)
    // ===============================
    db.ref(PATH_PEDIDOS).on('value', snapshot => {
        const pedidos = snapshot.val() || {};
        const container = document.getElementById('pedidos-container');
        container.innerHTML = ""; // Limpa para evitar duplicados no refresh
        
        const ids = Object.keys(pedidos);
        ids.reverse().forEach(id => {
            adicionarPedidoCard(pedidos[id], id);
        });

        // Toca som se o nÃºmero de pedidos aumentar
        if (ids.length > contadorPedidos && prontoParaTocar) {
            new Audio('alert.mpeg').play().catch(()=>{});
        }
        contadorPedidos = ids.length;
    });

    // ===============================
    // ðŸ”¹ FUNÃ‡ÃƒO ADICIONAR CARD
    // ===============================
    function adicionarPedidoCard(p, id){
        const li = document.createElement('li');
        li.className = 'pedido-card';
        li.id = `card-${id}`;

        let itensHtml = Array.isArray(p.itens) 
            ? p.itens.map(i => `â€¢ ${i.qtd}x ${i.produto} ${i.detalhes ? '<br><small>â€” '+i.detalhes+'</small>' : ''}`).join('<br>')
            : "Erro nos itens";

        li.innerHTML = `
            <h3>Cliente: ${p.cliente} <span class="badge-pagamento">${p.pagamento}</span></h3>
            <div class="info"><b> HorÃ¡rio:</b> ${p.horario}</div>
            <div class="info"><b> EndereÃ§o:</b> ${p.endereco}</div>
            <div class="itens-box"><b style="color:#ffcc00;"> ITENS DO PEDIDO:</b><br><div style="margin-top:5px;">${itensHtml}</div></div>
            <div class="info-obs">OBS: ${p.obs_cozinha || 'Nenhuma'}</div>
            <div class="financeiro-box">
                <div style="display:flex; justify-content:space-between; font-size:13px;">
                    <span>Subtotal: R$ ${parseFloat(p.subtotal || 0).toFixed(2)}</span>
                    ${p.desconto > 0 ? `<span style="color:#ff4444">Cupom: -R$ ${parseFloat(p.desconto).toFixed(2)}</span>` : ''}
                    <span>Taxa: R$ ${parseFloat(p.taxaEntrega || 0).toFixed(2)}</span>
                </div>
                <div class="total">TOTAL: R$ ${parseFloat(p.total || 0).toFixed(2)}</div>
            </div>
            <div class="btn-group">
                <button class="btn-cozinha" onclick="imprimir('producao', '${id}')">PRODUÃ‡ÃƒO</button>
                <button class="btn-motoboy" onclick="imprimir('entrega', '${id}')">ENTREGA</button>
            </div>
            <button class="btn-concluir" onclick="concluirPedido('${id}')">CONCLUIR PEDIDO</button>
        `;
        document.getElementById('pedidos-container').appendChild(li);
    }

    // ===============================
    // ðŸ”¹ IMPRIMIR (AJUSTADO)
    // ===============================
    function imprimir(tipo, id) {
        db.ref(PATH_PEDIDOS + '/' + id).once('value', s => {
            const p = s.val();
            if(!p) return;
            let lista = Array.isArray(p.itens) ? p.itens.map(i => `${i.qtd}x ${i.produto} ${i.detalhes ? '('+i.detalhes+')' : ''}`).join('<br>') : "";

            let html = `
                <div style="width:72mm; font-family:Arial; font-size:12px; padding:5px;">
                    <center><h2 style="margin:0;">CASA DA CERVEJA</h2>
                    <b>${tipo === 'producao' ? 'PEDIDO DE PRODUÃ‡ÃƒO' : 'COMPROVANTE DE ENTREGA'}</b><br>
                    ${p.horario}</center><hr>
                    <b>CLIENTE:</b> ${p.cliente}<br>
                    ${tipo === 'entrega' ? `<b>ENDEREÃ‡O:</b> ${p.endereco}<br><b>PAGAMENTO:</b> ${p.pagamento}<br>` : ''}
                    <hr><b>ITENS:</b><br>
                    <div style="font-size:14px; font-weight:bold;">${lista}</div><hr>
                    ${tipo === 'entrega' ? `<b>TOTAL: R$ ${parseFloat(p.total).toFixed(2)}</b><hr>` : ''}
                    <b>OBS:</b> ${p.obs_cozinha || 'Nenhuma'}
                </div>`;

            const win = document.getElementById('iframe-impressao').contentWindow;
            win.document.open();
            win.document.write(`<html><body style="margin:0;" onload="window.print()">${html}</body></html>`);
            win.document.close();
        });
    }

    // ===============================
    // âœ… CONCLUIR PEDIDO (CORRIGIDO)
    // ===============================
    function concluirPedido(id) {
        if(confirm("Deseja concluir este pedido?")){
            const ref = db.ref(PATH_PEDIDOS + '/' + id);
            ref.once('value', s => {
                const pedido = s.val();
                if(!pedido) return;
                db.ref(PATH_RELATORIOS).child(id).set(pedido).then(() => {
                    ref.remove();
                });
            });
        }
    }

    // ===============================
    // ðŸ“Š RELATÃ“RIO (CORRIGIDO)
    // ===============================
    function abrirRelatorio() {
        const t = document.getElementById('tabela-relatorio'); t.innerHTML = '';
        let soma = 0; let q = 0;
        db.ref(PATH_RELATORIOS).once('value', s => {
            s.forEach(c => {
                const r = c.val(); 
                const val = parseFloat(r.total || 0);
                soma += val; q++;
                t.innerHTML += `<tr><td>${r.horario}</td><td>${r.cliente}</td><td>R$ ${val.toFixed(2)}</td></tr>`;
            });
            document.getElementById('rel-total').innerText = 'R$ ' + soma.toFixed(2);
            document.getElementById('rel-qtd').innerText = q;
            document.getElementById('modal-relatorio').style.display = 'block';
        });
    }
    function fecharRelatorio() { document.getElementById('modal-relatorio').style.display = 'none'; }
    function limparRelatorio() { if(confirm("Limpar todo o histÃ³rico?")) db.ref(PATH_RELATORIOS).remove().then(() => abrirRelatorio()); }

</script>
</body>
</html>
